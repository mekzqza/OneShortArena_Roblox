--!strict
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")

-- ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ EventBus ‡πÅ‡∏•‡∏∞ Events
local EventBus = require(ReplicatedStorage.SystemsShared.EventBus)
local Events = require(ReplicatedStorage.Shared.Events)

local GameService = {}

-- ============================================================================
-- ‚öôÔ∏è Config (‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤)
-- ============================================================================
local MIN_PLAYERS = 1         -- ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏° (‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô 1 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ó‡∏™‡∏ï‡πå‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÑ‡∏î‡πâ)
local LOBBY_WAIT_TIME = 10    -- ‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á (‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)

-- ============================================================================
-- üìä State (‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)
-- ============================================================================
local isMatchActive = false
local lobbyTimer = LOBBY_WAIT_TIME

--[[\
    Init: ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡∏≠‡∏ô Server ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏´‡∏•‡∏î (‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Å‡∏≤‡∏£)
--]]
function GameService:Init()
    print("üèóÔ∏è GameService: Initializing...")
    
    -- ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå Spawns ‡πÉ‡∏´‡πâ‡∏ñ‡πâ‡∏≤‡∏•‡∏∑‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á
    if not Workspace:FindFirstChild("Spawns") then
        local folder = Instance.new("Folder")
        folder.Name = "Spawns"
        folder.Parent = Workspace
        warn("‚ö†Ô∏è GameService: Created 'Spawns' folder. Please add a SpawnLocation named 'LobbySpawn' inside it!")
    end
end

--[[\
    Start: ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏á Init (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏£‡∏¥‡∏á)
--]]
function GameService:Start()
    print("üèÅ GameService: Lobby System Started")

    -- 1. ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏° -> ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡πÄ‡∏Å‡∏¥‡∏î‡∏ó‡∏µ‡πà Lobby
    Players.PlayerAdded:Connect(function(player)
        self:OnPlayerJoin(player)
    end)
    
    -- 2. ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏≠‡∏Å -> ‡∏™‡πà‡∏á‡∏Ç‡πà‡∏≤‡∏ß‡∏ö‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏∑‡πà‡∏ô
    Players.PlayerRemoving:Connect(function(player)
        EventBus:Emit(Events.PLAYER_LEFT, player)
    end)

    -- 3. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏•‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡∏° (Game Loop) ‡πÅ‡∏¢‡∏Å Thread ‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡∏•‡∏≠‡∏î‡πÄ‡∏ß‡∏•‡∏≤
    task.spawn(function()
        while true do
            self:GameLoop()
            task.wait(1) -- ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ó‡∏∏‡∏Å‡πÜ 1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
        end
    end)
end

--[[\
    OnPlayerJoin: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà
--]]
function GameService:OnPlayerJoin(player: Player)
    print("üëã " .. player.Name .. " joined the lobby.")
    
    -- ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏∏‡∏î‡πÄ‡∏Å‡∏¥‡∏î Lobby ‡πÉ‡∏ô Workspace
    local spawns = Workspace:FindFirstChild("Spawns")
    local lobbySpawn = spawns and spawns:FindFirstChild("LobbySpawn")
    
    if lobbySpawn and lobbySpawn:IsA("SpawnLocation") then
        -- ‚úÖ ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏à‡∏∏‡∏î‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô LobbySpawn
        player.RespawnLocation = lobbySpawn
    else
        warn("‚ö†Ô∏è CRITICAL: 'LobbySpawn' (SpawnLocation) not found inside Workspace.Spawns!")
    end
    
    -- ‡∏™‡∏±‡πà‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏°‡∏≤‡∏¢‡∏∑‡∏ô‡πÉ‡∏ô Lobby)
    player:LoadCharacter()
    
    -- ‡πÅ‡∏à‡πâ‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏∑‡πà‡∏ô‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ñ‡∏ô‡∏°‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°
    EventBus:Emit(Events.PLAYER_JOINED, player)
end

--[[\
    GameLoop: ‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡∏° (‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)
--]]
function GameService:GameLoop()
    -- ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏° Logic ‡∏Ç‡∏≠‡∏á Lobby ‡πÑ‡∏õ
    if isMatchActive then
        return
    end

    -- === Logic: ‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡πÉ‡∏ô Lobby ===
    local playerCount = #Players:GetPlayers()
    
    if playerCount >= MIN_PLAYERS then
        -- ‡∏Ñ‡∏ô‡∏Ñ‡∏£‡∏ö! ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á
        lobbyTimer -= 1
        print("‚è≥ Waiting for match: " .. lobbyTimer)
        
        -- ‡∏™‡πà‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏õ‡∏ö‡∏≠‡∏Å UI (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏•‡∏Ç)
        EventBus:Emit(Events.UI_SHOW_NOTIFICATION, "Starting in " .. lobbyTimer)
        
        -- ‡∏ñ‡πâ‡∏≤‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏±‡∏ö‡∏ñ‡∏∂‡∏á 0 -> ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÄ‡∏•‡∏¢!
        if lobbyTimer <= 0 then
            self:StartMatch()
        end
    else
        -- ‡∏Ñ‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠ -> ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏ß‡∏•‡∏≤
        if lobbyTimer ~= LOBBY_WAIT_TIME then
            lobbyTimer = LOBBY_WAIT_TIME
            print("‚ùå Not enough players. Timer reset.")
            EventBus:Emit(Events.UI_SHOW_NOTIFICATION, "Waiting for players...")
        end
    end
end

--[[\
    StartMatch: ‡∏™‡∏±‡πà‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡∏à‡∏£‡∏¥‡∏á
--]]
function GameService:StartMatch()
    print("üöÄ STARTING MATCH!")
    isMatchActive = true
    
    -- ‡∏™‡πà‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°! (ArenaService ‡∏à‡∏∞‡∏£‡∏±‡∏ö‡∏ä‡πà‡∏ß‡∏á‡∏ï‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏£‡πå‡∏õ‡∏Ñ‡∏ô)
    EventBus:Emit(Events.GAME_STARTED)
end

return GameService