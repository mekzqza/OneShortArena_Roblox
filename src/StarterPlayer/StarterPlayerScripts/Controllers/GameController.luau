--[[
	GameController - ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô EventBus ‡∏ù‡∏±‡πà‡∏á Client
	
	üìå ‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà:
	Controller ‡∏ô‡∏µ‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô EventBus ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á Client-Client
	
	üîß ‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á:
	- ‡∏£‡∏±‡∏ö‡∏ü‡∏±‡∏á‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÉ‡∏ô Client
	- ‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Controllers ‡∏≠‡∏∑‡πà‡∏ô‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö
	- ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á On, Once, Emit
--]]

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local EventBus = require(ReplicatedStorage.SystemsShared.EventBus)
local Events = require(ReplicatedStorage.Shared.Events)

local player = Players.LocalPlayer
local GameController = {}
GameController.connections = {} -- ‡πÄ‡∏Å‡πá‡∏ö connections ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö cleanup

--[[
	Init: ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô Controller
	‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÇ‡∏î‡∏¢ Init.client.luau ‡πÄ‡∏°‡∏∑‡πà‡∏≠ client ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
--]]
function GameController:Init()
	print("üéÆ GameController: Initializing...")
	
	-- ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ‡∏ü‡∏±‡∏á‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°
	local gameStartedConn = EventBus:On(Events.GAME_STARTED, function(gameMode)
		print("üéÆ [Client] Game started! Mode:", gameMode)
		
		-- ‡πÅ‡∏à‡πâ‡∏á UI Controller ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á UI ‡πÄ‡∏Å‡∏°
		EventBus:Emit(Events.TOGGLE_UI, "GameHUD", true)
		EventBus:Emit(Events.TOGGLE_UI, "MainMenu", false)
		
		-- ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°
		EventBus:Emit(Events.AUDIO_PLAY, "GameStartSound")
	end)
	table.insert(self.connections, gameStartedConn)
	
	-- ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ‡∏ü‡∏±‡∏á‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏°‡∏à‡∏ö
	local gameEndedConn = EventBus:On(Events.GAME_ENDED, function(winner)
		print("üéÆ [Client] Game ended! Winner:", winner or "None")
		
		-- ‡πÅ‡∏™‡∏î‡∏á UI ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô
		EventBus:Emit(Events.TOGGLE_UI, "GameHUD", false)
		EventBus:Emit(Events.TOGGLE_UI, "ResultsScreen", true)
		
		-- ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞‡πÑ‡∏õ‡πÉ‡∏´‡πâ UI
		EventBus:Emit(Events.RESULTS_SHOW_WINNER, winner)
	end)
	table.insert(self.connections, gameEndedConn)
	
	-- ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ‡∏ü‡∏±‡∏á‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏î‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
	local scoreConn = EventBus:On(Events.PLAYER_SELF_SCORED, function(points)
		print("‚≠ê [Client] You scored " .. points .. " points!")
		
		-- ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡πÑ‡∏î‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
		EventBus:Emit(Events.EFFECT_SHOW_SCORE_POPUP, points)
		
		-- ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á
		EventBus:Emit(Events.AUDIO_PLAY, "ScoreSound")
	end)
	table.insert(self.connections, scoreConn)
	
	-- ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ‡πÉ‡∏ä‡πâ Once ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
	EventBus:Once(Events.FIRST_TIME_TUTORIAL, function()
		print("üìö [Client] Showing tutorial...")
		EventBus:Emit(Events.TOGGLE_UI, "Tutorial", true)
	end)
	
	-- ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ‡∏ü‡∏±‡∏á‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
	local notificationConn = EventBus:On(Events.NOTIFICATION_SHOW, function(message, duration)
		print("üì¢ [Client] Notification:", message)
		-- ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡πÉ‡∏´‡πâ UI Controller ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
		EventBus:Emit(Events.UI_SHOW_NOTIFICATION, message, duration or 3)
	end)
	table.insert(self.connections, notificationConn)
	
	-- ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ‡∏ü‡∏±‡∏á‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
	local settingsConn = EventBus:On(Events.SETTINGS_CHANGED, function(settingName, value)
		print("‚öôÔ∏è [Client] Setting changed:", settingName, "=", value)
		
		-- ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
		if settingName == "MusicVolume" then
			EventBus:Emit(Events.AUDIO_SET_MUSIC_VOLUME, value)
		elseif settingName == "SFXVolume" then
			EventBus:Emit(Events.AUDIO_SET_SFX_VOLUME, value)
		end
	end)
	table.insert(self.connections, settingsConn)
	
	-- ‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå‡∏ß‡πà‡∏≤ GameController ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß
	EventBus:Emit(Events.CONTROLLER_READY, "GameController")
	
	-- ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ‡πÅ‡∏™‡∏î‡∏á debug info ‡∏Ç‡∏≠‡∏á EventBus
	self:ShowDebugInfo()
	
	print("‚úÖ GameController initialized.")
end

--[[
	ShowDebugInfo: ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• debug ‡∏Ç‡∏≠‡∏á EventBus
	‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö development ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ß‡πà‡∏≤‡∏°‡∏µ events ‡∏≠‡∏∞‡πÑ‡∏£‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡πâ‡∏≤‡∏á
--]]
function GameController:ShowDebugInfo()
	-- ‡πÉ‡∏ä‡πâ task.defer ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ controllers ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏°‡∏µ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡πà‡∏≠‡∏ô
	-- ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏ô‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô debug ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
	-- ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏£‡∏¥‡∏á‡∏Ñ‡∏ß‡∏£‡πÉ‡∏ä‡πâ proper initialization system ‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏∂‡πà‡∏á‡∏û‡∏≤ timing
	task.defer(function()
		local events = EventBus:GetEventNames()
		if #events > 0 then
			print("üìã [GameController] Active EventBus Events:")
			for _, eventName in ipairs(events) do
				print("   -", eventName)
			end
		else
			print("üìã [GameController] No active events in EventBus")
		end
	end)
end

--[[
	OnPlayerScored: ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏≥‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏∑‡πà‡∏ô)
	@param points: number - ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ
--]]
function GameController:OnPlayerScored(points: number)
	-- ‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå‡πÅ‡∏à‡πâ‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏∑‡πà‡∏ô‡πÜ
	EventBus:Emit(Events.PLAYER_SELF_SCORED, points)
end

--[[
	RequestGameStart: ‡∏Ç‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏° (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á)
	@param gameMode: string - ‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏Å‡∏°
	
	‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏£‡∏¥‡∏á ‡∏≠‡∏≤‡∏à‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏≠‡∏∑‡πà‡∏ô‡πÜ
--]]
function GameController:RequestGameStart(gameMode: string)
	print("üéÆ [Client] Requesting game start:", gameMode)
	
	-- ‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå (‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏£‡∏¥‡∏á‡∏≠‡∏≤‡∏à‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ RemoteEvent ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡∏Å‡∏±‡∏ö Server)
	EventBus:Emit(Events.GAME_START_REQUESTED, gameMode)
end

--[[
	ShowNotification: ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
	@param message: string - ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á
	@param duration: number? - ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á (‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)
--]]
function GameController:ShowNotification(message: string, duration: number?)
	EventBus:Emit(Events.NOTIFICATION_SHOW, message, duration)
end

--[[
	Cleanup: ‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î connections
	‡∏Ñ‡∏ß‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠ Controller ‡∏ñ‡∏π‡∏Å‡∏ó‡∏≥‡∏•‡∏≤‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß
--]]
function GameController:Cleanup()
	print("üßπ [GameController] Cleaning up...")
	
	-- Disconnect ‡∏ó‡∏∏‡∏Å connection
	for _, connection in ipairs(self.connections) do
		if connection and connection.Connected then
			connection:Disconnect()
		end
	end
	
	self.connections = {}
	print("‚úÖ [GameController] Cleanup complete.")
end

return GameController
